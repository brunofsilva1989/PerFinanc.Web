@model PerFinanc.Web.Models.Dashboard.DashboardViewModel

@{
    ViewData["Title"] = "Dashboard";
    Layout = "_Layout";
}

<div class="container py-4">

    <div class="d-flex flex-wrap align-items-end justify-content-between gap-3 mb-4">
        <div>
            <h2 class="mb-1">Dashboard</h2>
            <div class="text-muted">
                Visão do mês:
                <strong>@(char.ToUpper(Model.MesNome[0]) + Model.MesNome.Substring(1))/@Model.Ano</strong>
            </div>
        </div>

        <form method="get" asp-action="Index" class="d-flex gap-2">
            <div>
                <label class="form-label mb-1">Ano</label>
                <input type="number" name="ano" class="form-control" value="@Model.Ano" min="2000" max="2100" />
            </div>
            <div>
                <label class="form-label mb-1">Mês</label>
                <select name="mes" class="form-select">
                    @for (int i = 1; i <= 12; i++)
                    {
                        <option value="@i" selected="@(i == Model.Mes)">
                            @System.Globalization.CultureInfo.GetCultureInfo("pt-BR").DateTimeFormat.GetMonthName(i)
                        </option>
                    }
                </select>
            </div>
            <div class="d-flex align-items-end">
                <button class="btn btn-primary">Filtrar</button>
            </div>
        </form>
    </div>

    <!-- ===== Linha 1: Entradas + Saldo ===== -->
    <div class="row g-3 mb-3">

        <div class="col-12 col-md-6 col-lg-3">
            <div class="card h-100 shadow-sm">
                <div class="card-body">
                    <div class="text-muted mb-1">Receitas</div>
                    <div class="fs-4 fw-bold text-success">@Model.TotalReceitas.ToString("C")</div>
                    <div class="text-muted small">@Model.QtdReceitas registro(s)</div>
                </div>
            </div>
        </div>

        <div class="col-12 col-md-6 col-lg-3">
            <div class="card h-100 shadow-sm">
                <div class="card-body">
                    <div class="text-muted mb-1">Freelancers</div>
                    <div class="fs-4 fw-bold text-success">@Model.TotalFreelancers.ToString("C")</div>
                    <div class="text-muted small">@Model.QtdFreelancers registro(s)</div>
                </div>
            </div>
        </div>

        <div class="col-12 col-md-6 col-lg-3">
            <div class="card h-100 shadow-sm">
                <div class="card-body">
                    <div class="text-muted mb-1">Total Entradas</div>
                    <div class="fs-4 fw-bold text-success">@Model.TotalEntradas.ToString("C")</div>
                    <div class="text-muted small">Receitas + Freelas</div>
                </div>
            </div>
        </div>

        <div class="col-12 col-md-6 col-lg-3">
            <div class="card h-100 shadow-sm">
                <div class="card-body">
                    <div class="text-muted mb-1">Saldo do mês</div>
                    <div class="fs-4 fw-bold @(Model.SaldoMes >= 0 ? "text-success" : "text-danger")">
                        @Model.SaldoMes.ToString("C")
                    </div>
                    <div class="text-muted small">Entradas - (Fixos + Gastos)</div>
                </div>
            </div>
        </div>
    </div>

    <!-- ===== Linha 2: Saídas + Gastos Gerais ===== -->
    <div class="row g-3 mb-3">

        <div class="col-12 col-md-6 col-lg-3">
            <div class="card h-100 shadow-sm">
                <div class="card-body">
                    <div class="text-muted mb-1">Total Previsto</div>

                    <!-- antes: <div class="fs-4 fw-bold">@Model.TotalPrevisto.ToString("C")</div> -->
                    <div class="fs-4 fw-bold text-primary">
                        @Model.TotalPrevisto.ToString("C")
                    </div>

                    <div class="text-muted small">@Model.QtdLancamentos lançamento(s)</div>
                </div>
            </div>
        </div>

        <div class="col-12 col-md-6 col-lg-3">
            <div class="card h-100 shadow-sm">
                <div class="card-body">
                    <div class="text-muted mb-1">Total Pago</div>
                    <div class="fs-4 fw-bold text-success">@Model.TotalPago.ToString("C")</div>
                    <div class="text-muted small">@Model.QtdPagos pago(s)</div>
                </div>
            </div>
        </div>

        <div class="col-12 col-md-6 col-lg-3">
            <div class="card h-100 shadow-sm">
                <div class="card-body">
                    <div class="text-muted mb-1">Em Aberto</div>
                    <div class="fs-4 fw-bold text-warning">@Model.TotalEmAberto.ToString("C")</div>
                    <div class="text-muted small">@Model.QtdEmAberto em aberto</div>
                </div>
            </div>
        </div>

        <div class="col-12 col-md-6 col-lg-3">
            <div class="card h-100 shadow-sm">
                <div class="card-body">
                    <div class="text-muted mb-1">Gastos Gerais</div>
                    <div class="fs-4 fw-bold text-danger">@Model.TotalGastosGerais.ToString("C")</div>
                    <div class="text-muted small">@Model.GastosGerais.Count registro(s)</div>
                </div>
            </div>
        </div>

    </div>

    <!-- ===== Linha 3: Alertas ===== -->
    <div class="row g-3 mb-3">
        <div class="col-12 col-md-6 col-lg-3">
            <div class="card h-100 shadow-sm">
                <div class="card-body">
                    <div class="text-muted mb-1">Vencidos</div>
                    <div class="fs-4 fw-bold text-danger">@Model.QtdVencidos</div>
                    <div class="text-muted small">sem pagamento e vencimento passou</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Progresso -->
    <div class="card shadow-sm mb-4">
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <div class="fw-semibold">Progresso do mês</div>
                <div class="text-muted">@Model.PercentPago.ToString("0.##")%</div>
            </div>

            <div class="progress" style="height: 12px;">
                <div class="progress-bar" role="progressbar" style="width: @Model.PercentPago.ToString("0.##")%"></div>
            </div>

            <div class="text-muted small mt-2">
                Pago: <strong>@Model.TotalPago.ToString("C")</strong> • Previsto: <strong>@Model.TotalPrevisto.ToString("C")</strong>
            </div>
        </div>
    </div>

    <!-- Detalhes harmônicos -->
    <div class="row g-3 mb-4">

        <!-- Linha 1: Receitas + Freelancers -->
        <div class="col-12 col-lg-6">
            <div class="card shadow-sm h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div class="fw-semibold">Últimas Receitas</div>
                        <a asp-controller="Receitas" asp-action="Index" class="btn btn-outline-secondary btn-sm">Ver tudo</a>
                    </div>

                    @if (Model.Receitas == null || !Model.Receitas.Any())
                    {
                        <div class="alert alert-info mb-0">Nenhuma receita nesse mês.</div>
                    }
                    else
                    {
                        <div class="table-responsive">
                            <table class="table table-sm table-hover align-middle mb-0">
                                <thead>
                                    <tr>
                                        <th>Descrição</th>
                                        <th class="text-center">Data</th>
                                        <th class="text-end">Valor</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var r in Model.Receitas.OrderByDescending(x => x.DataRecebimento).Take(5))
                                    {
                                        <tr>
                                            <td class="fw-semibold">@r.Descricao</td>
                                            <td class="text-center">@r.DataRecebimento.ToString("dd/MM/yyyy")</td>
                                            <td class="text-end">@r.Valor.ToString("C")</td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    }
                </div>
            </div>
        </div>

        <div class="col-12 col-lg-6">
            <div class="card shadow-sm h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div class="fw-semibold">Últimos Freelancers</div>
                        <a asp-controller="Freelancer" asp-action="Index" class="btn btn-outline-secondary btn-sm">Ver tudo</a>
                    </div>

                    @if (Model.Freelancers == null || !Model.Freelancers.Any())
                    {
                        <div class="alert alert-info mb-0">Nenhum freelance nesse mês.</div>
                    }
                    else
                    {
                        <div class="table-responsive">
                            <table class="table table-sm table-hover align-middle mb-0">
                                <thead>
                                    <tr>
                                        <th>Descrição</th>
                                        <th class="text-center">Data</th>
                                        <th class="text-end">Valor</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var f in Model.Freelancers.OrderByDescending(x => x.DataRecebimento).Take(5))
                                    {
                                        <tr>
                                            <td class="fw-semibold">@f.Descricao</td>
                                            <td class="text-center">@f.DataRecebimento.ToString("dd/MM/yyyy")</td>
                                            <td class="text-end">@f.Valor.ToString("C")</td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    }
                </div>
            </div>
        </div>

        <!-- Linha 2: Gastos Gerais (full) -->
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div class="fw-semibold">Últimos Gastos Gerais</div>
                        <a asp-controller="GastosGerais" asp-action="Index" class="btn btn-outline-secondary btn-sm">Ver tudo</a>
                    </div>

                    @if (Model.GastosGerais == null || !Model.GastosGerais.Any())
                    {
                        <div class="alert alert-info mb-0">Nenhum gasto geral nesse mês.</div>
                    }
                    else
                    {
                        <div class="table-responsive">
                            <table class="table table-sm table-hover align-middle mb-0">
                                <thead>
                                    <tr>
                                        <th>Descrição</th>
                                        <th class="text-center">Data</th>
                                        <th class="text-end">Valor</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var g in Model.GastosGerais.OrderByDescending(x => x.DataGasto).Take(5))
                                    {
                                        <tr>
                                            <td class="fw-semibold">@g.Descricao</td>
                                            <td class="text-center">@g.DataGasto.ToString("dd/MM/yyyy")</td>
                                            <td class="text-end">@g.Valor.ToString("C")</td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    }
                </div>
            </div>
        </div>

    </div>

    <!-- Lançamentos do mês -->
    <div class="card shadow-sm">
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <div class="fw-semibold">Lançamentos do mês</div>
                <a asp-controller="LancamentoContaFixa" asp-action="Index" class="btn btn-outline-secondary btn-sm">Ver tudo</a>
            </div>

            @if (Model.Lancamentos == null || !Model.Lancamentos.Any())
            {
                <div class="alert alert-info mb-0">Nenhum lançamento encontrado para esse mês.</div>
            }
            else
            {
                <div class="table-responsive">
                    <table class="table table-hover align-middle">
                        <thead>
                            <tr>
                                <th>Conta</th>
                                <th class="text-center">Vencimento</th>
                                <th class="text-end">Previsto</th>
                                <th class="text-end">Pago</th>
                                <th class="text-center">Status</th>
                                <th class="text-end">Ações</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var l in Model.Lancamentos.OrderBy(x => x.DataVencimento))
                            {
                                var vencido = !l.EstaPago && l.DataVencimento.Date < DateTime.Today;

                                <tr>
                                    <td class="fw-semibold">@l.ContaFixa?.Nome</td>
                                    <td class="text-center">@l.DataVencimento.ToString("dd/MM/yyyy")</td>
                                    <td class="text-end">@l.ValorPrevisto.ToString("C")</td>
                                    <td class="text-end">@((l.ValorPago ?? 0m).ToString("C"))</td>

                                    <td class="text-center">
                                        @if (l.EstaPago)
                                        {
                                            <span class="badge bg-success">Pago</span>
                                        }
                                        else if (vencido)
                                        {
                                            <span class="badge bg-danger">Vencido</span>
                                        }
                                        else
                                        {
                                            <span class="badge bg-warning text-dark">Em aberto</span>
                                        }
                                    </td>

                                    <td class="text-end">
                                        <div class="d-inline-flex gap-2">
                                            @if (!l.EstaPago)
                                            {
                                                <a class="btn btn-sm btn-primary"
                                                   asp-controller="LancamentoContaFixa"
                                                   asp-action="Pagar"
                                                   asp-route-id="@l.Id">Pagar</a>
                                            }
                                            else
                                            {
                                                <form asp-controller="LancamentoContaFixa"
                                                      asp-action="Estornar"
                                                      method="post"
                                                      class="d-inline">
                                                    @Html.AntiForgeryToken()
                                                    <input type="hidden" name="id" value="@l.Id" />
                                                    <button class="btn btn-sm btn-outline-danger"
                                                            onclick="return confirm('Estornar pagamento desse lançamento?');">
                                                        Estornar
                                                    </button>
                                                </form>
                                            }
                                        </div>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
        </div>
    </div>

</div>
